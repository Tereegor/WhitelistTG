# WhitelistTG

**Версия:** 1.0.3  
**Платформы:** Bukkit 1.21+, Velocity 3.3+  
**Java:** 17+  
**Автор:** Tereegor

---

## Описание

**WhitelistTG** — это система управления доступом к серверам Minecraft с интеграцией Telegram. Плагин обеспечивает централизованный контроль над whitelist-системой для сетей серверов, работающих под управлением прокси-сервера Velocity.

### Ключевые особенности

- **Мультисерверная архитектура** — единая база данных для всех серверов сети
- **Проверка на уровне прокси** — блокировка подключения до фактического входа на сервер
- **Telegram-интеграция** — автоматизированная выдача проходок через бота
- **Система приглашений** — возможность выдачи проходок стримерами и администраторами
- **Автодобавление** — автоматическое добавление игроков в whitelist при входе
- **Гибкое управление** — добавление/удаление по имени или UUID
- **Аудит доступа** — полная история регистраций с указанием источника

---

## Архитектура системы

### Модульная структура

```
whitelist-with-tg/
├── common/                 # Общий модуль
│   └── Модели данных, хранилище, утилиты
├── bukkit/                 # Сам плагин
│   └── Команды, Telegram-бот, обработка событий
├── velocity/               # Прокси Velocity
│   └── Проверка доступа на уровне прокси
└── pom.xml                 # Родительский pom
```

### Схема взаимодействия (пример: DuckTale)

```
┌──────────────────────────────────────────────────────────────┐
│                         VELOCITY                             │
│         Перехватывает подключения к серверам                 │
│         Проверяет наличие проходки в базе данных             │
│         Блокирует доступ при отсутствии прав                 │
└──────────────────────────────────────────────────────────────┘
           │                   │                    │
           ▼                   ▼                    ▼
    ┌─────────────┐     ┌─────────────┐      ┌─────────────┐
    │     HUB     │     │  DUCKHOOD   │      │  DUCKBURG   │
    │ WL: OFF     │     │ WL: ON      │      │ WL: ON      │
    │ TG-бот: ON  │     │ TG-бот: OFF │      │ TG-бот: OFF │
    │ /code       │     │ /invite     │      │             │
    └─────────────┘     └─────────────┘      └─────────────┘
           │
           ▼
    ┌─────────────┐
    │ TELEGRAM BOT│
    │ Выдача кодов│
    │ Уведомления │
    └─────────────┘
```

**Описание серверов DuckTale:**
- **hub** — точка входа, где игроки активируют коды через `/code`
- **duckhood** — основной игровой сервер, доступ по приглашениям (`/invite`)
- **duckburg** — дополнительный сервер, доступ по приглашениям

---

## Установка

### Требования

| Компонент | Минимальная версия |
|-----------|-------------------|
| Java | 17 |
| Paper/Spigot | 1.21+ |
| Velocity | 3.3+ |
| MySQL/MariaDB | 8.0+ / 10.3+ (опционально) |

### Сборка из исходного кода

```bash
git clone https://github.com/Tereegor/whitelist-with-tg.git
cd whitelist-with-tg
mvn clean package -DskipTests
```

После сборки JAR-файлы располагаются в следующих директориях:
- `bukkit/target/whitelist-bukkit-1.0.3.jar`
- `velocity/target/whitelist-velocity-1.0.3.jar`

### Размещение файлов

| Файл | Назначение |
|------|------------|
| `whitelist-bukkit-1.0.3.jar` | Директория `plugins/` серверов Paper/Spigot |
| `whitelist-velocity-1.0.3.jar` | Директория `plugins/` прокси Velocity |

> **Важно:** Файл `whitelist-common-1.0.3.jar` размещать не требуется — он автоматически включён в состав bukkit и velocity модулей.

---

## Конфигурация

### Bukkit-модуль

При первом запуске плагин создаёт файл `config.yml` с шаблоном конфигурации. Необходимо заполнить:
- `telegram.token` — токен Telegram бота (получить у @BotFather)
- `telegram.username` — username бота (без @)
- `database.username` и `database.password` — если используется MySQL/MariaDB

---

## Команды

### Bukkit-сервер

#### Административные команды

| Команда | Описание | Право доступа |
|---------|----------|---------------|
| `/wlt add <name\|uuid> <значение> [причина]` | Добавление игрока в whitelist | `whitelist.admin` |
| `/wlt remove <name\|uuid> <значение>` | Удаление игрока из whitelist | `whitelist.admin` |
| `/wlt list [страница]` | Просмотр списка игроков | `whitelist.admin` |
| `/wlt info <игрок>` | Детальная информация об игроке | `whitelist.admin` |
| `/wlt on` | Включение whitelist | `whitelist.admin` |
| `/wlt off` | Отключение whitelist | `whitelist.admin` |
| `/wlt autoadd [on\|off]` | Управление автодобавлением игроков | `whitelist.admin` |
| `/wlt confirm` | Подтверждение изменения автодобавления | `whitelist.admin` |
| `/wlt reload` | Перезагрузка конфигурации | `whitelist.admin` |

### Пользовательские команды

| Команда | Описание | Право доступа |
|---------|----------|---------------|
| `/code <код>` | Активация регистрационного кода | Все игроки |
| `/invite <игрок> [причина]` | Приглашение игрока | `whitelist.invite` |

### Velocity-прокси

| Команда | Описание |
|---------|----------|
| `/wlv check <игрок>` | Проверка статуса игрока |
| `/wlv cache clear` | Очистка кэша |
| `/wlv cache player <игрок>` | Очистка кэша игрока |
| `/wlv cache server <сервер>` | Очистка кэша сервера |
| `/wlv reload` | Перезагрузка конфигурации |

---

## Права доступа

| Право | Описание | По умолчанию |
|-------|----------|--------------|
| `whitelist.admin` | Полный доступ к управлению whitelist | Операторы |
| `whitelist.invite` | Право приглашать игроков | Отключено |
| `whitelist.bypass` | Обход проверки whitelist | Операторы |

---

## Telegram-бот

### Настройка бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в файл `config.yml` в секцию `telegram.token`
5. Укажите username бота в `telegram.username` (без символа @)


### Процесс регистрации игрока

```
┌─────────────────────────────────────────────────────────────┐
│  1. Игрок отправляет /start боту                            │
├─────────────────────────────────────────────────────────────┤
│  2. Бот отображает правила сервера с кнопкой принятия       │
├─────────────────────────────────────────────────────────────┤
│  3. Игрок нажимает "Принимаю правила"                       │
├─────────────────────────────────────────────────────────────┤
│  4. Бот генерирует уникальный код (например: ABC-123)       │
├─────────────────────────────────────────────────────────────┤
│  5. Игрок подключается к Hub-серверу                        │
├─────────────────────────────────────────────────────────────┤
│  6. Игрок вводит команду /code ABC-123                      │
├─────────────────────────────────────────────────────────────┤
│  7. Система определяет ник игрока и привязывает Telegram    │
├─────────────────────────────────────────────────────────────┤
│  8. Игрок получает доступ к серверам сети                   │
└─────────────────────────────────────────────────────────────┘
```

### Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Начало процесса регистрации |
| `/code` | Отображение текущего активного кода |
| `/help` | Справка по командам |

---

## Типы регистрации

Система отслеживает способ получения доступа каждым игроком:

| Тип | Описание | Пример |
|-----|----------|--------|
| `TELEGRAM_CODE` | Регистрация через Telegram-бот | Игрок активировал код из бота |
| `INVITE` | Приглашение от другого игрока | Стример пригласил командой /invite |
| `MANUAL` | Ручное добавление администратором | Добавлен командой /wl add |
| `IMPORT` | Импорт из внешней системы | Миграция данных |

---

## Хранилища данных

### SQLite (по умолчанию)

Встроенная файловая база данных. Не требует дополнительной настройки.

**Расположение файла:** `plugins/WhitelistTG/database.db`

**Преимущества:**
- Отсутствие внешних зависимостей
- Автоматическая инициализация
- Оптимальная производительность для малых и средних серверов
- Один файл базы данных

### H2

Альтернативная встроенная база данных. Поддерживается для совместимости.

**Расположение файла:** `plugins/WhitelistTG/database.db`

### MySQL / MariaDB

Рекомендуется для крупных сетей серверов и продакшен-окружений.

**Требования:**
- MySQL 8.0+ или MariaDB 10.3+
- Кодировка UTF-8

**Настройка:**
1. Создайте базу данных: `CREATE DATABASE whitelist CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;`
2. Укажите параметры подключения в `config.yml` (секция `database`)
3. Убедитесь, что параметры идентичны на всех серверах сети

---

## Рекомендации по развёртыванию

### Пример конфигурации для DuckTale

#### Hub-сервер (`plugins/WhitelistTG/config.yml`)

```yaml
server-name: "hub"
server-display-name: "&aHub"
whitelist:
  enabled: false
telegram:
  enabled: true
```

#### Duckhood-сервер (`plugins/WhitelistTG/config.yml`)

```yaml
server-name: "duckhood"
server-display-name: "&6Duckhood"
whitelist:
  enabled: true
telegram:
  enabled: false
```

#### Duckburg-сервер (`plugins/WhitelistTG/config.yml`)

```yaml
server-name: "duckburg"
server-display-name: "&bDuckburg"
whitelist:
  enabled: true
telegram:
  enabled: false
```

#### Velocity (`plugins/whitelisttg/config.yml`)

```yaml
bypass-servers:
  - hub

database:
  host: localhost
  database: whitelist
```

### Рекомендации

1. **Hub-сервер:**
   - Whitelist отключён (`enabled: false`)
   - Telegram-бот активен (`enabled: true`)
   - Команда `/code` доступна всем игрокам

2. **Игровые серверы (duckhood, duckburg):**
   - Whitelist включён (`enabled: true`)
   - Автодобавление отключено (`auto-add: false`) или включено для тестирования
   - Telegram-бот отключён (`enabled: false`)
   - Уникальный `server-name` для каждого сервера
   - Команда `/invite` доступна стримерам

3. **Velocity:**
   - Hub добавлен в `bypass-servers`
   - Единые параметры подключения к БД со всеми серверами

4. **База данных:**
   - Для сети из 3+ серверов рекомендуется MySQL/MariaDB
   - Единая БД для всех компонентов системы
   - Один игрок может иметь разные права на разных серверах